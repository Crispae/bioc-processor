Bootstrap: docker
From: lumai/odinson-extras:latest

%labels
    Author BioProcessor
    Version 1.0
    Description Odinson Document Indexer using official lumai/odinson-extras image

%post
    # Create default data directories
    mkdir -p /data/odinson/docs
    mkdir -p /data/odinson/index

    # Create the indexer configuration file
    cat > /app/indexer.conf << 'INDEXER_CONF'
# Odinson Indexer Configuration
# These paths are designed for container bind mounts

odinson {
  # Base data directory - bind mount your data here
  dataDir = "/data/odinson"

  # Path to Odinson JSON documents to be indexed
  docsDir = ${odinson.dataDir}/docs

  # Path where Lucene index will be created
  indexDir = ${odinson.dataDir}/index

  index {
    # Fields to store in the index for retrieval
    storedFields = ["raw", "lemma", "fileName"]
    
    # Field name for tracking source file names
    parentDocFieldFileName = "fileName"
    
    # Don't require documents to be ordered by ID (faster indexing)
    synchronizeOrderWithDocumentId = false
  }
}
INDEXER_CONF

    # Create the indexing wrapper script
    cat > /app/index_documents.sh << 'WRAPPER_SCRIPT'
#!/bin/bash
set -euo pipefail

# Odinson Document Indexer Wrapper Script
# Usage: index_documents.sh [OPTIONS]

show_help() {
    echo "Odinson Document Indexer"
    echo ""
    echo "Usage: index_documents.sh [OPTIONS]"
    echo ""
    echo "Options:"
    echo "  --docs-dir PATH    Directory containing Odinson JSON documents"
    echo "  --index-dir PATH   Directory where Lucene index will be created"
    echo "  --data-dir PATH    Base data directory (docs/ and index/ subdirs)"
    echo "  --help             Show this help message"
    echo ""
    echo "Examples:"
    echo "  # Using bind mounts with default paths"
    echo "  index_documents.sh"
    echo ""
    echo "  # Specify custom directories"
    echo "  index_documents.sh --docs-dir /data/json --index-dir /data/index"
}

# Default values - use /data/odinson as default (standard bind mount point)
DATA_DIR="/data/odinson"
DOCS_DIR=""
INDEX_DIR=""

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --docs-dir)
            DOCS_DIR="$2"
            shift 2
            ;;
        --index-dir)
            INDEX_DIR="$2"
            shift 2
            ;;
        --data-dir)
            DATA_DIR="$2"
            shift 2
            ;;
        --help|-h)
            show_help
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            show_help
            exit 1
            ;;
    esac
done

# Set docs and index dirs based on data dir if not explicitly set
if [ -z "$DOCS_DIR" ]; then
    DOCS_DIR="${DATA_DIR}/docs"
fi
if [ -z "$INDEX_DIR" ]; then
    INDEX_DIR="${DATA_DIR}/index"
fi

# Ensure index directory exists
mkdir -p "$INDEX_DIR"

echo "============================================"
echo "Odinson Document Indexer"
echo "============================================"
echo "Data directory: $DATA_DIR"
echo "Documents directory: $DOCS_DIR"
echo "Index directory: $INDEX_DIR"
echo "Start time: $(date)"
echo "============================================"

# Count documents
DOC_COUNT=$(find "$DOCS_DIR" -name "*.json" -o -name "*.json.gz" 2>/dev/null | wc -l)
echo "Found $DOC_COUNT document files to index"

if [ "$DOC_COUNT" -eq 0 ]; then
    echo "WARNING: No JSON documents found in $DOCS_DIR"
    echo "Expected files: *.json or *.json.gz"
    exit 1
fi

# Run the official odinson index-documents command
# The lumai/odinson-extras image has bin/index-documents script
exec /app/bin/index-documents \
    -Dodinson.dataDir="$DATA_DIR" \
    -Dodinson.docsDir="$DOCS_DIR" \
    -Dodinson.indexDir="$INDEX_DIR"
WRAPPER_SCRIPT
    chmod +x /app/index_documents.sh

%environment
    export HOME=/app
    export LC_ALL=C.UTF-8
    export LANG=C.UTF-8
    export JAVA_OPTS="-Xmx6G"

%runscript
    exec /app/index_documents.sh "$@"

%help
    Odinson Document Indexer Container
    
    Based on the official lumai/odinson-extras Docker image.
    Indexes Odinson JSON documents into a Lucene index for fast querying.

    Prerequisites:
        - Odinson JSON documents (produced by bioc_processor.sif or similar)

    Usage:
        # Build the container
        singularity build odinson_indexer.sif odinson_indexer.def

        # Basic usage with bind mounts (recommended)
        # Bind your docs to /data/odinson/docs and index output to /data/odinson/index
        singularity run \
            --bind /path/to/json/docs:/data/odinson/docs \
            --bind /path/to/output/index:/data/odinson/index \
            odinson_indexer.sif

        # Specify directories explicitly
        singularity run \
            --bind /shared:/shared \
            odinson_indexer.sif \
            --docs-dir /shared/bioc_output \
            --index-dir /shared/odinson_index

        # Use a single data directory (must have docs/ subdirectory)
        singularity run \
            --bind /shared/mydata:/data/odinson \
            odinson_indexer.sif

    Directory Structure Expected:
        /data/odinson/
        ├── docs/          # Input: Odinson JSON files (*.json, *.json.gz)
        └── index/         # Output: Lucene index files (created automatically)

    Memory Requirements:
        Default: 6GB heap (-Xmx6G)
        For large datasets, increase via JAVA_OPTS:
        
        SINGULARITYENV_JAVA_OPTS="-Xmx16G" singularity run ...

    Input Format:
        Odinson JSON documents with the structure:
        {
            "id": "document_id",
            "metadata": [...],
            "sentences": [...]
        }

    Output:
        Lucene index directory containing:
        - segments_* files
        - *.cfs, *.cfe files
        - write.lock
